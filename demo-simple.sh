#!/bin/bash

# =============================================================================
# Ansible-Pull Simple Demo Script - для быстрой демонстрации
# =============================================================================

# Цвета
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m'

echo -e "${CYAN}"
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║        ANSIBLE-PULL: РАЗВЕРТЫВАНИЕ КОНФИГУРАЦИИ ИЗ GIT        ║"
echo "║                                                                ║"
echo "║  Pull-based Configuration Management (Вытягивающее управление)║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

# =============================================================================
# РАЗДЕЛ 1: Структура репозитория
# =============================================================================
echo -e "${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}📁 СТРУКТУРА ANSIBLE-PULL РЕПОЗИТОРИЯ${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

echo -e "${MAGENTA}$ tree -L 2 ansible-repo${NC}\n"

cat <<'EOF'
ansible-repo/
├── local.yml                    ← Основной плейбук для ansible-pull
├── ansible.cfg                  ← Конфигурация Ansible
├── inventory                    ← Инвентарь хостов
├── roles/
│   ├── common/tasks/main.yml   ← Обновление пакетов, базовая конфиг
│   ├── web/tasks/main.yml      ← Установка Nginx/Apache
│   └── monitoring/tasks/main.  ← Мониторинг и логирование
├── group_vars/                  ← Групповые переменные
└── host_vars/                   ← Переменные отдельных хостов
EOF

echo ""

# =============================================================================
# РАЗДЕЛ 2: Основной плейбук local.yml
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}📋 ФАЙЛ: local.yml (Основной плейбук)${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

echo -e "${MAGENTA}$ cat ansible-repo/local.yml${NC}\n"

head -35 ansible-repo/local.yml

echo -e "\n${MAGENTA}... остальное содержимое ...${NC}\n"

# =============================================================================
# РАЗДЕЛ 3: Роли
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}🔧 РОЛИ КОНФИГУРАЦИИ${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

echo -e "${YELLOW}1️⃣  COMMON ROLE - Базовые настройки системы${NC}"
echo -e "${MAGENTA}   Путь: roles/common/tasks/main.yml${NC}"
cat <<'EOF'
   ✓ Обновление пакетов (apt/yum)
   ✓ Установка утилит (curl, wget, git, vim, htop, net-tools)
   ✓ Создание структуры директорий
   ✓ Генерация файла конфигурации
EOF

echo ""
echo -e "${YELLOW}2️⃣  WEB ROLE - Веб-сервер${NC}"
echo -e "${MAGENTA}   Путь: roles/web/tasks/main.yml${NC}"
cat <<'EOF'
   ✓ Установка Nginx (Debian/Ubuntu) или Apache (RedHat/CentOS)
   ✓ Создание web директории
   ✓ Развертывание HTML страницы с информацией о развертывании
EOF

echo ""
echo -e "${YELLOW}3️⃣  MONITORING ROLE - Мониторинг${NC}"
echo -e "${MAGENTA}   Путь: roles/monitoring/tasks/main.yml${NC}"
cat <<'EOF'
   ✓ Создание скриптов мониторинга системы
   ✓ Генерация логов развертывания
   ✓ Сохранение статуса конфигурации
EOF

echo ""

# =============================================================================
# РАЗДЕЛ 4: Команды для развертывания
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}🚀 КОМАНДЫ ДЛЯ РАЗВЕРТЫВАНИЯ${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

echo -e "${YELLOW}ВАРИАНТ 1: Локальное выполнение плейбука${NC}"
echo -e "${MAGENTA}$ ansible-playbook -i ansible-repo/inventory -c local ansible-repo/local.yml -v${NC}\n"

echo -e "${YELLOW}ВАРИАНТ 2: Использование ansible-pull (рекомендуется)${NC}"
echo -e "${MAGENTA}$ sudo ansible-pull -U <repository-url> -d /var/lib/ansible/pull local.yml${NC}\n"

echo -e "${YELLOW}ВАРИАНТ 3: ansible-pull с полными параметрами${NC}"
cat <<'EOF'
$ sudo ansible-pull \
    -U https://github.com/user/ansible-repo.git \
    -d /var/lib/ansible/pull \
    -i inventory \
    -l localhost \
    local.yml -v
EOF

echo ""

# =============================================================================
# РАЗДЕЛ 5: Архитектура
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}🏗️  АРХИТЕКТУРА РЕШЕНИЯ${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

cat <<'EOF'
┌───────────────────────────────────────────────┐
│      Git Repository (GitHub/GitLab)           │
│  • local.yml (плейбук)                        │
│  • roles/ (роли конфигурации)                 │
│  • ansible.cfg (конфигурация)                 │
└────────────────┬────────────────────────────┘
                 │
                 │ ansible-pull
                 │ (клонирует репо)
                 │
┌────────────────▼────────────────────────────┐
│    Target Virtual Machine                   │
│                                             │
│  Запускается ansible-pull:                  │
│  1. Клонирует репозиторий                   │
│  2. Запускает local.yml                     │
│  3. Применяет роли по очереди               │
│  4. Логирует результаты                     │
│  5. Выполняется через cron                  │
└─────────────────────────────────────────────┘
EOF

echo ""

# =============================================================================
# РАЗДЕЛ 6: На целевой VM
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}💻 ИСПОЛЬЗОВАНИЕ НА ЦЕЛЕВОЙ ВИРТУАЛЬНОЙ МАШИНЕ${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

echo -e "${YELLOW}Шаг 1: Установка требуемых пакетов${NC}"
echo -e "${MAGENTA}$ sudo apt-get install -y ansible git curl wget${NC}\n"

echo -e "${YELLOW}Шаг 2: Первоначальное развертывание${NC}"
echo -e "${MAGENTA}$ sudo ansible-pull \\${NC}"
echo -e "${MAGENTA}  -U https://github.com/user/ansible-repo.git \\${NC}"
echo -e "${MAGENTA}  -d /var/lib/ansible/pull \\${NC}"
echo -e "${MAGENTA}  local.yml -v${NC}\n"

echo -e "${YELLOW}Шаг 3: Настройка автоматических обновлений (cron)${NC}"
echo -e "${MAGENTA}$ sudo crontab -e${NC}"

cat <<'EOF'

# Добавить строку для запуска каждые 30 минут:
*/30 * * * * /usr/bin/ansible-pull \
  -U https://github.com/user/ansible-repo.git \
  -d /var/lib/ansible/pull \
  local.yml >> /var/log/ansible-pull.log 2>&1

# Или ежечасно:
0 * * * * /usr/bin/ansible-pull \
  -U https://github.com/user/ansible-repo.git \
  -d /var/lib/ansible/pull \
  local.yml >> /var/log/ansible-pull.log 2>&1
EOF

echo ""

# =============================================================================
# РАЗДЕЛ 7: Файлы, создаваемые при развертывании
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}📂 ФАЙЛЫ НА ЦЕЛЕВОЙ СИСТЕМЕ ПО ЗАВЕРШЕНИИ${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

cat <<'EOF'
/var/lib/ansible/pull/            - Клонированный репозиторий
/var/log/ansible-pull.log          - Логи выполнения
/opt/application/                  - Директория приложения
  ├── config/app.conf              - Конфигурация
  └── logs/                         - Логи приложения
/opt/monitoring/                   - Мониторинг
  ├── system.log                   - Логи системы
  ├── status.conf                  - Статус развертывания
  └── check_system.sh              - Скрипт мониторинга
/var/www/html/index.html           - Веб-страница
EOF

echo ""

# =============================================================================
# РАЗДЕЛ 8: Проверка результатов
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}✅ ПРОВЕРКА РЕЗУЛЬТАТОВ РАЗВЕРТЫВАНИЯ${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

echo -e "${YELLOW}Просмотр статуса развертывания:${NC}"
echo -e "${MAGENTA}$ cat /opt/monitoring/status.conf${NC}\n"

echo -e "${YELLOW}Просмотр конфигурации приложения:${NC}"
echo -e "${MAGENTA}$ cat /opt/application/config/app.conf${NC}\n"

echo -e "${YELLOW}Просмотр логов ansible-pull:${NC}"
echo -e "${MAGENTA}$ tail -50 /var/log/ansible-pull.log${NC}\n"

echo -e "${YELLOW}Запуск скрипта мониторинга:${NC}"
echo -e "${MAGENTA}$ /opt/monitoring/check_system.sh${NC}\n"

# =============================================================================
# РАЗДЕЛ 9: Преимущества
# =============================================================================
echo -e "\n${BLUE}┌──────────────────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}  ${YELLOW}✨ ПРЕИМУЩЕСТВА ANSIBLE-PULL${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────────────────┘${NC}\n"

cat <<'EOF'
✓ Не требует SSH доступа администратора к целевым хостам
✓ Хосты инициируют подключение к серверу (вытягивают конфиг)
✓ Работает за NAT, firewall и прокси серверами
✓ Масштабируется на тысячи хостов без перегрузки управляющего сервера
✓ Полностью децентрализовано - нет bottleneck
✓ Периодические обновления через cron
✓ Простая отладка через логи на каждой машине
✓ Все конфигурации в версионной системе (Git)
EOF

echo ""

# =============================================================================
# ИТОГ
# =============================================================================
echo -e "\n${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${NC}                  ДЕМОНСТРАЦИЯ ЗАВЕРШЕНА                 ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}                                                         ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}  Все файлы готовы в директории: ${WHITE}ansible-repo/${GREEN}           ${GREEN}║${NC}"
echo -e "${GREEN}║${NC}  Полная документация в: ${WHITE}README.md${GREEN}                    ${GREEN}║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${CYAN}📚 Дополнительная информация:${NC}"
echo -e "   📖 Документация: https://docs.ansible.com/ansible/latest/"
echo -e "   📖 Ansible-Pull: https://docs.ansible.com/ansible/latest/cli_tools/ansible-pull.html"
echo -e "   📖 Best Practices: https://docs.ansible.com/ansible/latest/tips_tricks/\n"
