#!/bin/bash

# 📖 РУКОВОДСТВО ПО ИНТЕРАКТИВНОМУ ANSIBLE-PULL

cat << "EOF"

╔════════════════════════════════════════════════════════════════════════╗
║                                                                        ║
║         📚  РУКОВОДСТВО: ИНТЕРАКТИВНЫЙ ANSIBLE-PULL                  ║
║                                                                        ║
║         Работа с любым GitHub репозиторием для ansible-pull           ║
║                                                                        ║
╚════════════════════════════════════════════════════════════════════════╝

════════════════════════════════════════════════════════════════════════════

📌 БЫСТРЫЙ СТАРТ:

════════════════════════════════════════════════════════════════════════════

Способ 1️⃣ - Интерактивный ввод URL:
  $ bash run-interactive.sh

Способ 2️⃣ - Передача URL как параметр:
  $ bash ansible-pull-interactive.sh https://github.com/user/repo.git

════════════════════════════════════════════════════════════════════════════

🎯 ОСНОВНЫЕ ФУНКЦИИ:

════════════════════════════════════════════════════════════════════════════

1️⃣  ВВОД РЕПОЗИТОРИЯ
    • Введите URL GitHub репозитория
    • Поддерживает HTTPS и SSH ссылки
    • Примеры:
      - https://github.com/user/ansible-repo.git
      - git@github.com:user/ansible-repo.git

2️⃣  ПРОВЕРКА РЕПОЗИТОРИЯ
    • Клонирует репозиторий локально
    • Проверяет доступность
    • Сохраняет в /tmp/ansible-pull-work/

3️⃣  ПРОСМОТР СТРУКТУРЫ
    • Показывает дерево файлов репозитория
    • Выводит содержимое директорий
    • Находит важные файлы

4️⃣  ПРОВЕРКА ANSIBLE ФАЙЛОВ
    • Ищет YAML плейбуки
    • Проверяет наличие ролей
    • Находит файлы инвентаря

5️⃣  ПРОСМОТР СОДЕРЖИМОГО
    • Показывает содержимое плейбуков
    • Выводит файлы инвентаря
    • Отображает конфигурацию Ansible

6️⃣  ПРОВЕРКА СИНТАКСИСА
    • Валидирует YAML файлы
    • Проверяет синтаксис плейбуков
    • Требует установки Ansible

7️⃣  ГЕНЕРАЦИЯ КОМАНД
    • Создает готовые команды ansible-pull
    • Примеры для разных сценариев
    • Команды для cron

8️⃣  ЛОКАЛЬНОЕ ТЕСТИРОВАНИЕ
    • Запускает плейбук в режиме --check
    • Показывает что будет изменено
    • Не применяет изменения

9️⃣  GIT ИНФОРМАЦИЯ
    • История коммитов
    • Текущая ветка
    • Статус репозитория

🔟 ИТОГОВАЯ ИНФОРМАЦИЯ
    • Сводка обо всем репозитории
    • Список найденных файлов
    • Рекомендуемые следующие шаги

════════════════════════════════════════════════════════════════════════════

💡 ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ:

════════════════════════════════════════════════════════════════════════════

ПРИМЕР 1: Работа с публичным репозиторием
────────────────────────────────────────────
$ bash ansible-pull-interactive.sh https://github.com/ansible/ansible-examples.git

Программа:
  1. Клонирует репозиторий
  2. Показывает его структуру
  3. Проверяет наличие плейбуков
  4. Генерирует команды ansible-pull
  5. Тестирует локально

────────────────────────────────────────────

ПРИМЕР 2: Интерактивный ввод
────────────────────────────────────────────
$ bash run-interactive.sh

1. Программа запросит URL
2. Введите: https://github.com/user/my-ansible.git
3. Выбирайте действия из меню
4. Программа все сделает за вас

────────────────────────────────────────────

ПРИМЕР 3: Работа с приватным репозиторием
────────────────────────────────────────────
$ bash ansible-pull-interactive.sh git@github.com:user/private-repo.git

Требуется:
  • SSH ключ добавлен в GitHub
  • ssh-agent запущен
  • Доступ к приватному репозиторию

════════════════════════════════════════════════════════════════════════════

🔐 БЕЗОПАСНОСТЬ:

════════════════════════════════════════════════════════════════════════════

HTTPS ссылки:
  • Не требуют настройки SSH
  • Могут запросить пароль/токен
  • Пример: https://github.com/user/repo.git

SSH ссылки:
  • Требуют ssh-агент
  • Не требуют пароля
  • Пример: git@github.com:user/repo.git

Для приватных репозиториев:
  1. Создайте личный токен на GitHub
  2. Используйте его в HTTPS URL
  3. Или настройте SSH ключи

════════════════════════════════════════════════════════════════════════════

📊 ВЫВОД КОМАНД ANSIBLE-PULL:

════════════════════════════════════════════════════════════════════════════

Программа генерирует три варианта команд:

ВАРИАНТ 1: Базовая команда
  $ sudo ansible-pull \
      -U https://github.com/user/ansible-repo.git \
      -d /var/lib/ansible/pull \
      playbook.yml -v

ВАРИАНТ 2: С инвентарем
  $ sudo ansible-pull \
      -U https://github.com/user/ansible-repo.git \
      -i inventory \
      -d /var/lib/ansible/pull \
      playbook.yml -v

ВАРИАНТ 3: Для cron (каждые 30 минут)
  */30 * * * * ansible-pull \
    -U https://github.com/user/ansible-repo.git \
    -d /var/lib/ansible/pull \
    playbook.yml >> /var/log/ansible-pull.log 2>&1

════════════════════════════════════════════════════════════════════════════

🛠️ ТРЕБОВАНИЯ:

════════════════════════════════════════════════════════════════════════════

Обязательно:
  ✓ git (для клонирования репозиториев)
  ✓ bash
  ✓ интернет для доступа к GitHub

Опционально:
  ✓ ansible (для проверки синтаксиса и тестирования)
  ✓ tree (для красивого вывода структуры)

Установка (Linux):
  $ sudo apt-get install -y git ansible

Установка (macOS):
  $ brew install git ansible

════════════════════════════════════════════════════════════════════════════

🚀 ТИПИЧНЫЙ РАБОЧИЙ ПРОЦЕСС:

════════════════════════════════════════════════════════════════════════════

1. ИССЛЕДОВАНИЕ РЕПОЗИТОРИЯ
   $ bash ansible-pull-interactive.sh https://github.com/user/repo.git
   # Просмотр структуры и содержимого

2. ПРОВЕРКА ANSIBLE ФАЙЛОВ
   # Убедитесь что плейбуки есть и валидны

3. ЛОКАЛЬНОЕ ТЕСТИРОВАНИЕ
   # Проверьте плейбук в режиме --check

4. ГЕНЕРАЦИЯ КОМАНД
   # Получите готовую команду ansible-pull

5. ИСПОЛЬЗОВАНИЕ НА ВМ
   # Скопируйте команду на целевую машину

6. АВТОМАТИЗАЦИЯ
   # Добавьте в cron для периодического выполнения

════════════════════════════════════════════════════════════════════════════

❓ ЧАСТО ЗАДАВАЕМЫЕ ВОПРОСЫ:

════════════════════════════════════════════════════════════════════════════

Q: Как использовать приватный репозиторий?
A: Используйте SSH ссылку: git@github.com:user/repo.git
   Убедитесь что SSH ключ добавлен на GitHub.

Q: Как тестировать плейбук локально?
A: Используйте опцию 8 (Локальное тестирование).
   Она запустит плейбук в режиме --check.

Q: Как добавить в cron?
A: Скопируйте команду из варианта 3 и выполните:
   sudo crontab -e
   # Вставьте команду

Q: Какой формат URL?
A: Работают оба формата:
   - https://github.com/user/repo.git
   - git@github.com:user/repo.git

Q: Что если плейбук не в корне?
A: Программа найдет все YAML файлы в репозитории.
   Обычно основной плейбук в корне репозитория.

════════════════════════════════════════════════════════════════════════════

📝 ПРИМЕРЫ GITHUB РЕПОЗИТОРИЕВ:

════════════════════════════════════════════════════════════════════════════

Публичные примеры для тестирования:

1. Ansible Examples:
   https://github.com/ansible/ansible-examples.git

2. Ansible Playbook Repository:
   https://github.com/ansible/playbooks

3. Geerlingguy's Ansible Roles:
   https://github.com/geerlingguy/ansible-role-docker

════════════════════════════════════════════════════════════════════════════

✅ ГОТОВО К ИСПОЛЬЗОВАНИЮ!

════════════════════════════════════════════════════════════════════════════

Запустите прямо сейчас:
  bash run-interactive.sh

Или с параметром:
  bash ansible-pull-interactive.sh https://github.com/user/repo.git

════════════════════════════════════════════════════════════════════════════

EOF
